<!DOCTYPE html>
<html>
<head>
    <title>Earthquake Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <div id="map" style="width: 100%; height: 600px;"></div>
    <div id="time-slider"></div>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

    <form id="filter-form">
        <label for="startdate">Start Date:</label>
        <input type="date" id="startdate" required>
        <label for="enddate">End Date:</label>
        <input type="date" id="enddate" required>
        <label for="minmagnitude">Min Magnitude:</label>
        <input type="number" id="minmagnitude" step="0.1" required>
        <button type="submit">Filter</button>
    </form>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([41.33, 19.82], 7); // Centered in Albania
    
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);
    
        // Fetch earthquake data
        fetch('/earthquakes')
            .then(response => response.json())
            .then(data => {
                data.forEach(quake => {
                    L.marker([quake.latitude, quake.longitude])
                        .bindPopup(`<b>Magnitude:</b> ${quake.magnitude}<br><b>Time:</b> ${new Date(quake.timestamp).toLocaleString()}`)
                        .addTo(map);
                });
            })
            .catch(err => console.error('Error fetching earthquake data:', err));
            document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const startdate = document.getElementById('startdate').value;
        const enddate = document.getElementById('enddate').value;
        const minmagnitude = document.getElementById('minmagnitude').value;

        fetch(`/earthquakes?startdate=${startdate}&enddate=${enddate}&minmagnitude=${minmagnitude}`)
            .then(response => response.json())
            .then(data => {
                // Clear existing markers and add new ones
                markers.clearLayers();
                data.forEach(quake => {
                    L.marker([quake.latitude, quake.longitude])
                        .bindPopup(`<b>Magnitude:</b> ${quake.magnitude}<br><b>Time:</b> ${new Date(quake.timestamp).toLocaleString()}`)
                        .addTo(markers);
                });
                map.addLayer(markers);
            })
            .catch(err => console.error('Error fetching filtered data:', err));
    });
    noUiSlider.create(document.getElementById('time-slider'), {
        start: [2000, 2025],
        range: {
            'min': 1900,
            'max': 2025
        },
        step: 1,
        tooltips: true,
        connect: true
    });

    document.getElementById('time-slider').noUiSlider.on('change', function(values) {
        const startdate = `${Math.floor(values[0])}-01-01`;
        const enddate = `${Math.floor(values[1])}-12-31`;

        fetch(`/earthquakes?startdate=${startdate}&enddate=${enddate}`)
            .then(response => response.json())
            .then(data => {
                markers.clearLayers();
                data.forEach(quake => {
                    L.marker([quake.latitude, quake.longitude])
                        .bindPopup(`<b>Magnitude:</b> ${quake.magnitude}<br><b>Time:</b> ${new Date(quake.timestamp).toLocaleString()}`)
                        .addTo(markers);
                });
                map.addLayer(markers);
            });
    });
    fetch('/earthquakes')
        .then(response => response.json())
        .then(data => {
            const heatData = data.map(quake => [quake.latitude, quake.longitude, quake.magnitude]);
            const heat = L.heatLayer(heatData, { radius: 25 }).addTo(map);
        });
        const markers = L.markerClusterGroup();
    fetch('/earthquakes')
        .then(response => response.json())
        .then(data => {
            data.forEach(quake => {
                L.marker([quake.latitude, quake.longitude])
                    .bindPopup(`<b>Magnitude:</b> ${quake.magnitude}<br><b>Time:</b> ${new Date(quake.timestamp).toLocaleString()}`)
                    .addTo(markers);
            });
            map.addLayer(markers);
        });
    </script>
    
    
</body>
</html>
